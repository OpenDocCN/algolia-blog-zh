<html>
<head>
<title>Salt Incident: May 3rd 2020 Retrospective and Update - Algolia Blog | Algolia Blog</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">盐事件:2020年5月3日回顾和更新-阿尔戈利亚博客|阿尔戈利亚博客</h1>
<blockquote>原文：<a href="https://www.algolia.com/blog/engineering/salt-incident-may-3rd-2020-retrospective-and-update/#0001-01-01">https://www.algolia.com/blog/engineering/salt-incident-may-3rd-2020-retrospective-and-update/#0001-01-01</a></blockquote><div><div class="css-t54cg4"><table>
<tbody>
<tr>
<td class="translated"><strong>总结&amp;关键要点</strong><ul>
<li class="translated"><span>2020年5月3日，Algolia的基础设施因</span> <a href="https://www.zdnet.com/article/saltstack-salt-critical-bugs-allow-data-center-cloud-server-hijacking-as-root/" target="_blank" rel="noopener noreferrer"> <span> salt配置管理漏洞CVE-2020-11651 </span> </a> <span>经历了一次攻击。通过这个漏洞，两种类型的恶意软件代码能够进入Algolia的配置管理器——一种旨在挖掘加密货币，另一种则充当后门服务器。</span></li>
<li class="translated"><span>鉴于恶意软件的性质，虽然没有任何数据泄露，也没有收集、更改、销毁或损坏数据，但在5月3日，不到2%的Algolia搜索服务客户经历了超过5分钟的服务中断，不到1%的客户经历了超过10分钟的服务中断。</span></li>
<li class="translated"><span>截至世界协调时2020年5月3日17:33，Algolia的9000多名客户的所有搜索服务都正常运行。</span></li>
<li class="translated"><span>作为这次经历的结果，Algolia审查并更新了其安全协议、措施和监控实践，以进一步保护和加强其服务。</span></li>
<li class="translated"><span> Algolia赢得了客户的信任，其服务的安全性和性能至关重要。因此，它向其客户和社区提供以下事件的详细叙述，以及一个</span> <a href="#FAQ" rel="noopener noreferrer"> <span>常见问题解答</span> </a> <span>。</span></li>
</ul>
</td>
</tr>
</tbody>
</table>
<p> </p>
<p class="translated"><span>你可能听说过</span> <a href="https://labs.f-secure.com/advisories/saltstack-authorization-bypass/" target="_blank" rel="noopener noreferrer"> <span> salt配置管理漏洞</span></a><span>(</span><a href="https://nvd.nist.gov/vuln/detail/CVE-2020-11651" target="_blank" rel="noopener noreferrer"><span>CVE-2020-11651</span></a><span>和</span><a href="https://nvd.nist.gov/vuln/detail/CVE-2020-11652" target="_blank" rel="noopener noreferrer"><span>【CVE-2020-11652</span></a><span>)，冲击了几家大型组织。该漏洞涉及salt master的通信协议，特别是其已验证的协议，该协议有一个重大缺陷，允许绕过健全性检查，并调用敏感的内部函数，这可能允许盗用通信密钥，甚至继续使用未经验证的命令。</span></p>
<p class="translated">2020年5月3日晚上，我们确实遭到了利用这个 <a href="https://github.com/saltstack/salt/issues/57057" target="_blank" rel="noopener noreferrer"> <span>漏洞</span> </a> <span>的攻击。</span></p>
<p class="translated">在Algolia，我们一直对问题保持坦诚和透明。我们正在进行这次公开的事后分析，目的是向我们的用户提供有关此次事件的完整和详细的信息，同时也是为了从长远来看改进我们自己。</p>
<h3 class="translated"><a id="waking-up-to-the-incident" class="anchor" href="#waking-up-to-the-incident" aria-hidden="true"> <svg aria-hidden="true" class="octicon octicon-link" version="1.1" viewbox="0 0 16 16"> <path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"/> </svg> </a> <b>苏醒事件</b></h3>
<p class="translated">这一切都始于5月3日星期日，巴黎时间凌晨3点12分，我们一位核心工程师的电话突然响起。多个警报同时触发，因为API对许多客户不再可用。事件的规模之大足以证明唤醒我们的基础架构团队提供帮助是正确的，另外两名工程师很快在半夜加入进来帮助调查问题。</p>
<p class="translated"><span>服务器持续发出警报，一个接一个地关闭，没有明确的原因，远程访问这些服务器也是不可能的。一开始怀疑是大规模网络中断，我们的提供商之一OVH迅速协助调查，排除了这种假设。同时，我们在审计日志时发现了可疑的命令。</span></p>
<h3 class="translated"><b>罪魁祸首:配置管理</b> <b> <br/> </b></h3>
<p class="translated"><span>我们能够快速确定我们的配置管理器是攻击的受害者，向我们欧洲集群中的许多服务器传播恶意软件命令。我们的部分基础设施现在正在运行</span> <i> <span>而不仅仅是我们的代码</span> </i> <span>。</span> <span> <br/> </span></p>
<p class="translated">配置管理是基础设施的关键部分，尤其是在大型云中，这一点有时会被忽视。能够在数千台服务器上部署要安装的包、设置服务并维护它们是必须的。但这可能成为一个致命的弱点，因为它涉及到一个中央服务器，该服务器获得了访问大量服务器的特权。一个错误可能被放大到令人痛苦的程度。</p>
<h3 class="translated"><a id="what-was-impacted" class="anchor" href="#what-was-impacted" aria-hidden="true"> <svg aria-hidden="true" class="octicon octicon-link" version="1.1" viewbox="0 0 16 16"> <path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"/> </svg> </a> <b>什么受到了冲击</b></h3>
<p class="translated"><span>超过500台服务器受到影响，其中大多数暂时失去了索引服务，但其中一些也失去了搜索功能。由于我们设计架构的方式，这并没有对我们的客户产生重大影响，因为额外的服务器保持健康并接管了搜索流量。</span></p>
<p class="translated"><span>在逐个恢复服务器时，我们主要关心的是准确评估攻击的确切规模。第一个问题总是:有数据被破坏了吗？分析恶意软件执行的有效载荷，我们得出结论，攻击的唯一目标是挖掘加密货币，而不是收集、更改、破坏或损坏数据。我们本可以不那么幸运，这是一个我们不会很快忘记的教训。</span></p>
<p class="translated"><span>此外，我们的部分监控网络因检测到的故障而过载，但状态页面显示一切正常。这是混乱和误导。我们正在努力修复它，我们将回顾性地更新状态指示器，以反映我们检测到的问题。</span></p>
<p class="translated"><span>以下是我们的一些用户在索引方面遭遇的停机时间，但有时也包括搜索服务:</span></p>
<ul>
<li class="translated"><span>超过700个集群中有15个(~2%)受到超过5分钟的搜索停机时间的影响。</span></li>
<li class="translated"><span> 6个集群(不到1%)受到超过10分钟的搜索停机时间的影响。</span></li>
</ul>
<h3 class="translated"><a id="how-we-responded-reclaiming-the-infrastructure" class="anchor" href="#how-we-responded-reclaiming-the-infrastructure" aria-hidden="true"> <svg aria-hidden="true" class="octicon octicon-link" version="1.1" viewbox="0 0 16 16"> <path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"/> </svg> </a> <b>我们如何应对:重建基础设施</b></h3>
<p class="translated"><span>我们首先关闭了我们所有基础设施中涉及该事件的配置管理器，保留文件供以后进行取证分析。然后，我们与不同的提供商合作，开始逐一重启所有受影响的服务器，并调查它们的状态。我们发现注入了两个恶意软件——一个用于挖掘加密货币，另一个作为后门服务器。我们开始查杀所有恶意软件，将文件恢复到原始状态，然后建立一个计划，逐个重新安装所有受影响的服务器。</span></p>
<p class="translated">作为我们标准协议的一部分，公告会定期在<a href="https://status.algolia.com/" target="_blank" rel="noopener noreferrer"><span>【https://status.algolia.com/</span></a><span>更新，我们会向联系我们支持团队的客户通报相关情况。</span></p>
<p class="translated"><span>在第一个警报被触发七个小时后，我们在移除所有注入的恶意软件后重启了最后一台服务器，并开始在配置管理端工作。十几个人参与了恢复工作，不知疲倦地重建受损的服务设施。</span></p>
<h3 class="translated"><a id="how-did-we-get-here" class="anchor" href="#how-did-we-get-here" aria-hidden="true"> <svg aria-hidden="true" class="octicon octicon-link" version="1.1" viewbox="0 0 16 16"> <path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"/> </svg> </a> <b>我们是怎么来到这里的？</b></h3>
<p class="translated"><span>受影响的组件是一个较旧的工具，一直运行良好，但我们计划在接下来的两个季度中对其进行返工。我们现在已经制定了一个保护环境的临时修复措施，我们正在积极地工作，比计划更快地重新设计系统。</span></p>
<h3 class="translated"><a id="what-we-did-so-far" class="anchor" href="#what-we-did-so-far" aria-hidden="true"> <svg aria-hidden="true" class="octicon octicon-link" version="1.1" viewbox="0 0 16 16"> <path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"/> </svg> </a> <b>到目前为止我们做了什么:</b></h3>
<ul>
<li class="translated"><span>我们已经通过更新和添加额外的IP过滤来保护受影响的SaltStack服务，只允许</span> <b>我们的服务器</b> <span>连接到它。</span></li>
<li class="translated"><span>我们从头开始重新安装了SaltStack服务器。</span></li>
<li class="translated">我们在应用服务器和SaltStack服务器上轮换与SaltStack服务通信所需的安全密钥。</li>
<li class="translated"><span>我们在我们所有的服务器上轮换秘密。</span></li>
<li class="translated"><span>我们将控制平面服务的访问密钥限制在服务器的特定IP上，预计将从这些IP上访问和使用它们。</span></li>
</ul>
<h3 class="translated"><a id="what-we-plan-to-do-over-the-coming-days" class="anchor" href="#what-we-plan-to-do-over-the-coming-days" aria-hidden="true"> <svg aria-hidden="true" class="octicon octicon-link" version="1.1" viewbox="0 0 16 16"> <path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"/> </svg> </a> <b>我们未来几天的计划:</b></h3>
<ul>
<li class="translated"><span>我们将审查我们所有的控制平面服务，并添加一个额外的访问控制层，以确保单个控制故障不会导致服务暴露。</span></li>
<li class="translated"><span>作为一项额外的安全措施，我们将重新安装基础架构中所有与SaltStack有联系的服务器，以确保所有服务器都不会出现任何意外变化。</span></li>
<li class="translated"><span>我们将建立一个流程来监控和审查常见漏洞和暴露(CVE ),即使在假期和周末也是如此，以避免像五一假期之后是周末这样的组合，并缩短发现CVE和应用补丁之间的反应时间。</span></li>
<li class="translated"><span>如果您应用的SLA受到影响，我们将根据适用的服务水平协议提供适当的服务积分。</span></li>
</ul>
<p class="translated"><span>我们服务的安全性和正常运行时间是我们的两个核心优先事项。因此，这次停机没有任何可接受的借口。您可以相信我们会从中吸取教训，并改善我们的设置和基础设施，使这种情况不会再次发生。</span></p>
<p class="translated"><span>T24】_ _ _ _ _ _ _ _ _ _ _ _</span></p>
<p> </p>
<h3 class="translated"><a id="faqs" class="anchor" href="#faqs" aria-hidden="true"> <svg aria-hidden="true" class="octicon octicon-link" version="1.1" viewbox="0 0 16 16"> <path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"/> </svg> </a> <span>常见问题</span></h3>
<ul>
<li class="translated"><strong>此次攻击对客户及其用户的搜索体验有何影响？</strong><ul>
<li class="translated"><span>不到1%的客户经历过搜索体验下降或搜索中断。</span></li>
</ul>
</li>
</ul>
<ul>
<li class="translated"><strong>我如何知道我的站点在这次攻击中是否受到影响？</strong><ul>
<li class="translated">如果你没有意识到任何问题，这意味着你很可能没有受到影响，所有的安全机制都工作正常。如果您想查看这段时间内您的应用程序的状态，您可以在仪表板、部分监控和选项卡状态中查看。</li>
</ul>
</li>
</ul>
<ul>
<li class="translated"><strong>你提到部分基础设施不仅仅运行Algolia的代码？运行的另一个代码到底是什么，它做了什么？</strong><ul>
<li class="translated"><span>代码试图获得尽可能多的CPU来挖掘加密货币，并阻止服务器重启。</span></li>
</ul>
</li>
</ul>
<ul>
<li class="translated"><strong>Algolia的服务器受攻击影响的百分比是多少？</strong></li>
</ul>
<ul>
<li class="translated"><strong>如果重新启动最后一台服务器的整个过程需要7个小时，那么搜索停机时间为什么只有大约10分钟？</strong><ul>
<li class="translated"><span>由于我们的架构，我们的应用集群中有很高的冗余度，在绝大多数情况下，整个集群都没有受到影响。我们设计了这种体系结构来承受数据中心停机，这种情况非常类似。一些服务器没有成功重启，团队在接下来的几个小时里一直在处理这些孤立的案例。</span></li>
</ul>
</li>
</ul>
<p class="translated"><span> ____________ </span></p>
<h3 class="translated"><a id="references" class="anchor" href="#references" aria-hidden="true"> <svg aria-hidden="true" class="octicon octicon-link" version="1.1" viewbox="0 0 16 16"> <path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"/> </svg> </a> <b>参考文献</b></h3>
<p class="translated">【https://nvd.nist.gov/vuln/detail/CVE-2020-11651<span>T21</span>T24】</p>
<p class="translated"><a href="https://nvd.nist.gov/vuln/detail/CVE-2020-11652" target="_blank" rel="noopener noreferrer"><span>https://nvd.nist.gov/vuln/detail/CVE-2020-11652</span></a></p>
<p class="translated"><a href="https://thehackernews.com/2020/05/saltstack-rce-exploit.html" target="_blank" rel="noopener noreferrer"><span>https://the hacker news . com/2020/05/salt stack-rce-exploit . html</span></a></p>
</div></div>    
</body>
</html>