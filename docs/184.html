<html>
<head>
<title>Add Autocomplete search to your Strapi CMS - Algolia Blog | Algolia Blog</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">添加自动完成搜索到您的Strapi CMS - Algolia博客</h1>
<blockquote>原文：<a href="https://www.algolia.com/blog/engineering/add-autocomplete-search-to-your-strapi-cms/#0001-01-01">https://www.algolia.com/blog/engineering/add-autocomplete-search-to-your-strapi-cms/#0001-01-01</a></blockquote><div><div class="css-t54cg4"><p class="translated">Strapi是一个开源的无头CMS，它构建api抽象来检索您的内容，而不管它存储在哪里。它是构建内容驱动的应用程序(如博客和其他媒体网站)的一个很好的工具。</p>
<p class="translated">在本文中，您将使用Algolia的Autocomplete.js库和社区构建的Strapi搜索插件，通过Next.js前端向Strapi博客添加交互式搜索。</p>
<h2 class="translated"><a id="prerequisites" class="anchor" href="#prerequisites" aria-hidden="true"> <svg aria-hidden="true" class="octicon octicon-link" version="1.1" viewbox="0 0 16 16"> <path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"/> </svg> </a>先决条件</h2>
<p class="translated">Strapi和Algolia Autcomplete.js都是使用Javascript构建的，所以您需要安装node v.12。<br/>。<br/>您将使用Strapi和Next.js构建本指南<a href="https://strapi.io/blog/build-a--react-js-strapi">中的基本博客应用程序。在构建您的搜索体验之前，您应该熟悉文章中的步骤。</a></p>
<p class="translated">您还需要一个Algolia帐户进行搜索。您可以使用现有的Algolia帐户或<a href="https://www.algolia.com/users/sign_up?utm_source=blog&amp;utm_medium=main-blog&amp;utm_campaign=devrel&amp;utm_id=agency-finder">注册一个免费帐户</a>。</p>
<h2 class="translated"><a id="building-the-back-end" class="anchor" href="#building-the-back-end" aria-hidden="true"> <svg aria-hidden="true" class="octicon octicon-link" version="1.1" viewbox="0 0 16 16"> <path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"/> </svg> </a>建筑后端</h2>
<p class="translated">首先创建一个目录来保存项目的前端和后端:</p>
<pre class="lang:sh decode:true ">mkdir blog-strapi-algolia &amp;&amp; cd blog-strapi-algolia</pre>
<p class="translated">Strapi有一组预烤模板，您可以使用它们快速启动并运行CMS。这些都包括Strapi本身以及预定义的内容类型和样本数据。如果您还没有Strapi博客，您可以使用博客模板快速创建一个。</p>
<pre class="lang:sh decode:true ">npx create-strapi-app backend  --quickstart --template @strapi/template-blog@1.0.0 blog</pre>
<p class="translated">脚本安装完成后，在https://localhost:1337上添加一个admin用户，这样您就可以登录到Strapi仪表板。这个脚本为我们设置了大部分后端，包括一些演示博客帖子。您可以在<a href="https://strapi.io/blog/build-a-blog-with-next-react-js-strapi">快速入门</a>中了解更多关于设置的信息。</p>
<p class="translated">接下来，您需要索引您的演示内容。幸运的是，Strapi社区为您提供了由社区成员Mattias van den Belt构建的搜索插件和Algolia索引提供程序。你可以在文档中阅读更多关于Mattie的插件，但是启动和运行只需要几项配置。</p>
<p class="translated">继续并停止您的Strapi服务器，以便您可以使用<code>npm</code>(或<code>yarn</code>)安装插件。</p>
<pre class="lang:sh decode:true ">cd backend &amp;&amp; npm install @mattie-bundle/strapi-plugin-search @mattie-bundle/strapi-provider-search-algolia --save</pre>
<p class="translated">您需要将Algolia API密钥和应用ID添加到您的Strapi环境中。您可以通过导航Algolia仪表盘的“设置&gt;团队和访问&gt; api密钥”来管理您的密钥，或者直接进入https://algolia.com/account/api-keys.。由于Strapi正在修改您的Algolia索引，您需要提供管理API密钥(用于演示)或创建一个对您的生产项目具有适当访问权限的密钥。</p>
<pre class="lang:sh decode:true "># .env&#13;
// ...&#13;
ALGOLIA_PROVIDER_APPLICATION_ID=XXXXXXXXXX&#13;
ALGOLIA_PROVIDER_ADMIN_API_KEY=XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX&#13;
</pre>
<p class="translated">准备好凭证后，最后一步是配置插件。在您的<code>backend</code>目录下创建或修改<code>./config/plugins.js</code>文件。你想让插件为你的博客索引<code>article</code>和<code>category</code>内容类型。</p>
<pre class="lang:js decode:true ">'use strict';&#13;
&#13;
module.exports = ({ env }) =&gt; ({&#13;
  // ...&#13;
  search: {&#13;
    enabled: true,&#13;
    config: {&#13;
      provider: 'algolia',&#13;
      providerOptions: {&#13;
        apiKey: env('ALGOLIA_PROVIDER_ADMIN_API_KEY'),&#13;
        applicationId: env('ALGOLIA_PROVIDER_APPLICATION_ID'),&#13;
      },&#13;
      contentTypes: [&#13;
        { name: 'api::article.article' },&#13;
        { name: 'api::category.category' },&#13;
      ],&#13;
    },&#13;
  },&#13;
});&#13;
</pre>
<p class="translated">重启您的Strapi服务器以获取这些环境变量和新插件(<code>npm run develop</code>)。当新内容是<code>Published</code>时，搜索插件触发，所以你需要或者<code>Unpublish</code>和<code>Publish</code>演示文章，或者创建一个新的。加载Strapi管理面板(https://localhost:1337/admin)并导航到<strong>内容管理器&gt;集合类型&gt;文章</strong>，然后或者点击现有文章并<code>Unpublish</code>它，或者点击<code>Create new Entry</code>。点击文章上的<code>Publish</code>将此条目编入您的Algolia应用程序。如果您也想索引那些内容类型，您可以对<code>category</code>内容类型做同样的事情。</p>
<h2 class="translated"><a id="building-the-front-end" class="anchor" href="#building-the-front-end" aria-hidden="true"> <svg aria-hidden="true" class="octicon octicon-link" version="1.1" viewbox="0 0 16 16"> <path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"/> </svg> </a>建筑前端</h2>
<p class="translated">既然您已经构建了后端并填充了索引，那么是时候为您的用户构建前端了。</p>
<p class="translated">Strapi有一篇很棒的博文，带你构建一个Next.js驱动的前端。您将在这些步骤的基础上进行构建。你可以自己浏览他们的<a href="https://strapi.io/blog/build-a-blog-with-next-react-js-strapi">快速入门</a>，或者如果你想直接加入搜索，你可以直接复制<a href="https://github.com/chuckmeyer/blog-strapi-frontend/tree/no-search-version">这个回购</a>。</p>
<pre class="lang:sh decode:true ">git clone --single-branch --branch no-search-version git@github.com:chuckmeyer/blog-strapi-frontend.git frontend</pre>
<p class="translated">别忘了跑步</p>
<pre class="lang:sh decode:true ">cd frontend &amp;&amp; npm install</pre>
<p class="translated">如果你克隆了回购协议的前端。</p>
<p class="translated">这足以让基本的博客网站开始运行。您可以通过在<code>frontend</code>目录中启动服务器来测试它。</p>
<pre class="lang:sh decode:true ">npm run dev</pre>
<p class="translated">唯一缺少的就是搜索。您将使用Algolia Autocomplete.js库为您的博客导航栏添加自动完成搜索体验。当用户在字段中键入内容时，自动完成功能会通过提供完整的术语或结果来“完成”他们的想法。自动完成库是源代码不可知的，所以您还需要Algolia InstantSearch库来连接到后端的索引。</p>
<pre class="lang:sh decode:true ">npm install @algolia/autocomplete-js algoliasearch @algolia/autocomplete-theme-classic --save</pre>
<p class="translated">要在React项目中使用自动完成库，首先需要创建一个自动完成组件来包装该库。您可以在<a href="https://www.algolia.com/doc/ui-libraries/autocomplete/integrations/using-react/">自动完成文档</a>中找到样板文件。</p>
<p class="translated"><code>./frontend/components/autocomplete.js</code></p>
<pre class="lang:js decode:true ">import { autocomplete } from '@algolia/autocomplete-js';&#13;
import React, { createElement, Fragment, useEffect, useRef } from 'react';&#13;
import { render } from 'react-dom';&#13;
&#13;
export function Autocomplete(props) {&#13;
  const containerRef = useRef(null);&#13;
&#13;
  useEffect(() =&gt; {&#13;
    if (!containerRef.current) {&#13;
      return undefined;&#13;
    }&#13;
&#13;
    const search = autocomplete({&#13;
      container: containerRef.current,&#13;
      renderer: { createElement, Fragment },&#13;
      render({ children }, root) {&#13;
        render(children, root);&#13;
      },&#13;
      ...props,&#13;
    });&#13;
&#13;
    return () =&gt; {&#13;
      search.destroy();&#13;
    };    &#13;
  }, [props]);&#13;
&#13;
  return &lt;div ref={containerRef} /&gt;;&#13;
}&#13;
</pre>
<p class="translated">就像在后端一样，您需要您的Algolia凭证来连接到API。由于前端只需要<em>从索引中读取</em>，您可以使用应用程序的搜索关键字。创建一个<code>./frontend/.env.local</code>文件来存储您的凭证。</p>
<pre class="lang:sh decode:true ">NEXT_PUBLIC_ALGOLIA_APP_ID=XXXXXXXXXX&#13;
NEXT_PUBLIC_ALGOLIA_SEARCH_API_KEY=XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX&#13;
</pre>
<p class="translated">现在，您可以初始化与Algolia的连接，并通过更新<code>./frontend/components/nav.js</code>中的代码来添加新的自动完成组件。</p>
<pre class="lang:js decode:true ">import React from "react";&#13;
import Link from "next/link";&#13;
&#13;
import { getAlgoliaResults } from '@algolia/autocomplete-js';&#13;
import algoliasearch from 'algoliasearch';&#13;
import { Autocomplete } from './autocomplete';&#13;
import SearchItem from './searchItem';&#13;
import "@algolia/autocomplete-theme-classic";&#13;
&#13;
const searchClient = algoliasearch(&#13;
  process.env.NEXT_PUBLIC_ALGOLIA_APP_ID,&#13;
  process.env.NEXT_PUBLIC_ALGOLIA_SEARCH_API_KEY,&#13;
);&#13;
&#13;
const Nav = ({ categories }) =&gt; {&#13;
  return (&#13;
    &lt;div&gt;&#13;
      &lt;nav className="uk-navbar-container" data-uk-navbar&gt;&#13;
        &lt;div className="uk-navbar-left"&gt;&#13;
          &lt;ul className="uk-navbar-nav"&gt;&#13;
            &lt;li&gt;&#13;
              &lt;Link href="/"&gt;&#13;
                &lt;a&gt;Strapi Blog&lt;/a&gt;&#13;
              &lt;/Link&gt;&#13;
            &lt;/li&gt;&#13;
          &lt;/ul&gt;&#13;
        &lt;/div&gt;&#13;
        &lt;div className="uk-navbar-center"&gt;&#13;
          &lt;Autocomplete&#13;
            openOnFocus={false}&#13;
            detachedMediaQuery=''&#13;
            placeholder="Search for articles"&#13;
            getSources={({ query }) =&gt; [&#13;
              {&#13;
                sourceId: "articles",&#13;
                getItemUrl( {item} ) { return `/article/${item.slug}`},&#13;
                getItems() {&#13;
                  return getAlgoliaResults({&#13;
                    searchClient,&#13;
                    queries: [&#13;
                      {&#13;
                        indexName: "development_api::article.article",&#13;
                        query,&#13;
                      }&#13;
                    ]&#13;
                  })&#13;
                },&#13;
                templates: {&#13;
                  item({ item, components}) {&#13;
                    return &lt;SearchItem hit={item} components={components} /&gt;;&#13;
                  }&#13;
                }&#13;
              },&#13;
            ]}&#13;
          /&gt;&#13;
        &lt;/div&gt;&#13;
        &lt;div className="uk-navbar-right"&gt;&#13;
          &lt;ul className="uk-navbar-nav"&gt;&#13;
            {categories.map((category) =&gt; {&#13;
              return (&#13;
                &lt;li key={category.id}&gt;&#13;
                  &lt;Link href={`/category/${category.attributes.slug}`}&gt;&#13;
                    &lt;a className="uk-link-reset"&gt;{category.attributes.name}&lt;/a&gt;&#13;
                  &lt;/Link&gt;&#13;
                &lt;/li&gt;&#13;
              );&#13;
            })}&#13;
          &lt;/ul&gt;&#13;
        &lt;/div&gt;&#13;
      &lt;/nav&gt;&#13;
    &lt;/div&gt;&#13;
  );&#13;
};&#13;
&#13;
export default Nav;&#13;
</pre>
<p class="translated">如您所见，您正在向<code>Autocomplete</code>组件传递几个参数:</p>
<ul>
<li class="translated"><code>openOnFocus={false}</code>–告诉您的搜索在用户开始输入之前不要填充结果</li>
<li class="translated"><code>detachedMediaQuery=''</code>–以分离模式打开搜索，为您的结果提供更多空间</li>
<li class="translated"><code>placeholder="Search for articles"</code>–搜索前出现在搜索框中的文本</li>
<li class="translated"><code>getSources={({ query }) =&gt;</code>–为您的自动完成体验定义数据源的地方</li>
</ul>
<p class="translated">请记住，自动完成是源代码不可知的。您可以基于应用程序中的API、库或静态内容来定义源代码。这里，您使用<code>autocomplete-js</code>库中的<code>getAlgoliaResults</code>函数将一个名为<code>articles</code>的源绑定到您的Algolia索引。</p>
<pre class="lang:js decode:true ">              {&#13;
                sourceId: "articles",&#13;
                getItemUrl( {item} ) { return `/article/${item.slug}`},&#13;
                getItems() {&#13;
                  return getAlgoliaResults({&#13;
                    searchClient,&#13;
                    queries: [&#13;
                      {&#13;
                        indexName: "development_api::article.article",&#13;
                        query,&#13;
                      }&#13;
                    ]&#13;
                  })&#13;
                },&#13;
                templates: {&#13;
                  item({ item, components}) {&#13;
                    return &lt;SearchItem hit={item} components={components} /&gt;;&#13;
                  }&#13;
                }&#13;
              },&#13;
&#13;
</pre>
<p class="translated"><code>development_api::article.article</code>是上面的Strapi搜索插件为您的<code>article</code>内容类型生成的索引。当您进入生产阶段时，插件将在同一个应用程序中创建一个单独的<code>production_api::article.article</code>索引。</p>
<p class="translated"><code>getItemUrl()</code>部分设置键盘导航，而<code>getItems()</code>使用搜索框中的查询词从索引中检索文章。</p>
<p class="translated">注意上面的代码引用了一个<code>SearchItem</code>组件。这是您将用来告诉Autocomplete如何呈现您的搜索结果的<code>template</code>。用下面的代码添加一个名为<code>./frontend/components/searchItem.js</code>的新组件。</p>
<pre class="lang:js decode:true ">import React from "react";&#13;
&#13;
function SearchItem({ hit, components }) {&#13;
  return (&#13;
    &lt;a className="aa-ItemLink" href={`/article/${hit.slug}`}&gt;&#13;
      &lt;div className="aa-ItemContent"&gt;&#13;
        &lt;div className="ItemCategory"&gt;{hit.category.name}&lt;/div&gt;&#13;
        &lt;div className="aa-ItemContentBody"&gt;&#13;
          &lt;div className="aa-ItemContentTitle"&gt;&#13;
            &lt;components.Highlight hit={hit} attribute="title" /&gt;&#13;
          &lt;/div&gt;&#13;
          &lt;div className="aa-ItemContentDescription"&gt;&#13;
            &lt;components.Highlight hit={hit} attribute="description" /&gt;&#13;
          &lt;/div&gt;&#13;
        &#13;
        &lt;/div&gt;&#13;
      &lt;/div&gt;&#13;
    &lt;/a&gt;&#13;
  );&#13;
};&#13;
&#13;
export default SearchItem;&#13;
</pre>
<p class="translated">使用这段代码，您将显示与文章、标题和描述相关联的<code>category</code>。使用<code>components.Highlight</code>组件来强调匹配用户查询的属性部分。</p>
<p class="translated">就这样，你完成了！用<code>npm run dev</code>启动你的前端服务器。现在，您应该会在页面顶部看到自动完成搜索框。点击它打开模态搜索界面，你可以开始输入你的搜索词。</p>
<p class="translated"><a class="aligncenter" href="https://www.algolia.com/developers/code-exchange/backend-tools/integrate-strapi-with-algolia/"> <img loading="lazy" class="wp-image-13777" src="../Images/7665551c18b687f25dcadc15cb213b7d.png" alt="" data-original-src="https://blog-api.algolia.com/wp-content/uploads/2022/01/CodeX@2x.png"/> </a></p>
<p class="translated">你可以在<a href="https://codesandbox.io/s/github/chuckmeyer/blog-strapi-frontend"> codesandbox </a>上看到这个前端的托管版本，尽管后端容器启动可能需要一些时间。前端代码的之前的<a href="https://github.com/chuckmeyer/blog-strapi-frontend/tree/no-search-version">和</a>之后的<a href="https://github.com/chuckmeyer/blog-strapi-frontend/tree/with-search-version">版本也可以在Github上获得。</a></p>
<p class="translated">如果你用这个博客做了一些很酷的东西，请在Twitter上与我们分享。</p>
</div></div>    
</body>
</html>