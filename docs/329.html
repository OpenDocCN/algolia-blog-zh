<html>
<head>
<title>Sanity + Algolia: add search to an open source headless CMS - Algolia Blog | Algolia Blog</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Sanity + Algolia:向开源无头CMS添加搜索</h1>
<blockquote>原文：<a href="https://www.algolia.com/blog/product/sanity-algolia-add-search-to-an-open-source-headless-cms/#0001-01-01">https://www.algolia.com/blog/product/sanity-algolia-add-search-to-an-open-source-headless-cms/#0001-01-01</a></blockquote><div><div class="css-t54cg4"><p class="translated">在本文中，我们将研究如何将<a href="https://www.sanity.io/" target="_blank" rel="noopener"> Sanity.io </a>与Algolia集成。Sanity.io是一个内容平台，附带一个可以定制的开源headless CMS，以及一个托管的实时数据存储，允许您读取和更新数据。Sanity.io背后的理念是，您应该能够将内容视为数据，并将其带到您拥有的任何产品或应用程序中。</p>
<p class="translated">现在，CMS通常没有搜索功能。自己在上面构建一个最简单的搜索功能都不容易，更不用说包含诸如允许输入错误和分面等重要功能的东西了。这就是我们的Algolia插件所做的事情:它在你的CMS上添加了一个灵活且功能丰富的搜索功能。</p>
<h2 class="translated"><a id="cmsalgolia-using-webhooks" class="anchor" href="#cmsalgolia-using-webhooks" aria-hidden="true"><svg aria-hidden="true" class="octicon octicon-link" version="1.1" viewbox="0 0 16 16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"/></svg></a>CMS&lt;&gt;Algolia使用webhooks</h2>
<p class="translated">有许多方法可以将CMS与Algolia集成在一起。最有效的方法之一是利用webhooks。您可以创建一个API作为webhook端点，并配置您的CMS在内容更改时触发webhook。在您的API中，您可以在Algolia的索引中创建、更新或删除相应的记录。</p>
<p class="translated">因此，您需要创建一个API作为webhook。如果你有一个网络服务器，你可以在那里添加一个API。或者，如果您在Netlify或Vercel上托管了Sanity Studio，您可以编写一个无服务器函数作为您的API。</p>
<p class="translated">然而，这部分可能很麻烦。在API中，您需要检查触发webhook请求的原因:记录的创建、更新或删除。之后，您需要调用相应的方法将更改应用到Algolia。这不是一大块代码，但是如果没有正确的数据模式，这可能会很耗时。这就是理智-algolia的用武之地，它帮助我们处理双方的问题。</p>
<h2 class="translated"><a id="a-better-way-sanity-algolia-with-tutorial" class="anchor" href="#a-better-way-sanity-algolia-with-tutorial" aria-hidden="true"> <svg aria-hidden="true" class="octicon octicon-link" version="1.1" viewbox="0 0 16 16"> <path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"/> </svg> </a>一种更好的方式:理智——阿洛利亚(附教程)</h2>
<p class="translated">使用sanity-algolia，您需要为algolia索引转换有效负载。</p>
<p class="translated">以下是方法。</p>
<p class="translated">安装依赖项:</p>
<pre class="show-lang:2 lang:default decode:true ">npm install algoliasearch sanity-algolia&#13;
&#13;
# or&#13;
&#13;
yarn add algoliasearch sanity-algolia</pre>
<p class="translated">创建API:</p>
<pre class="lang:default decode:true ">import algoliasearch from 'algoliasearch';&#13;
import sanityClient from '@sanity/client';&#13;
import indexer, { flattenBlocks } from 'sanity-algolia';&#13;
&#13;
const algolia = algoliasearch(...);&#13;
const sanity = sanityClient(...);&#13;
&#13;
export default function handler(req, res) {&#13;
  const sanityAlgolia = indexer(&#13;
    {&#13;
      post: {&#13;
        index: algolia.initIndex('posts'),&#13;
      },&#13;
    },&#13;
    document =&gt; {&#13;
      switch (document._type) {&#13;
        case 'post':&#13;
          return {&#13;
            title: document.title,&#13;
            path: document.slug.current,&#13;
            publishedAt: document.publishedAt,&#13;
            excerpt: flattenBlocks(document.excerpt),&#13;
          };&#13;
        default:&#13;
          throw new Error(`Unknown type: ${document.type}`);&#13;
      }&#13;
    }&#13;
  );&#13;
&#13;
  return sanityAlgolia&#13;
    .webhookSync(sanity, req.body)&#13;
    .then(() =&gt; res.status(200).send('ok'));&#13;
}</pre>
<p class="translated">假设这个API的端点部署在</p>
<pre class="show-lang:2 lang:default decode:true ">https://my-example/api/update-algolia</pre>
<p class="translated">访问您的<a href="https://manage.sanity.io" target="_blank" rel="noopener">健全仪表板</a>来添加webhook。<br/> <a href="https://blog-api.algolia.com/wp-content/uploads/2021/04/image1-1.jpg"> <img loading="lazy" class="aligncenter size-full wp-image-11687" src="../Images/4bf4c415ec1bae417f81fa5c053f6b0b.png" alt="" srcset="https://blog-api.algolia.com/wp-content/uploads/2021/04/image1-1.jpg 1200w, https://blog-api.algolia.com/wp-content/uploads/2021/04/image1-1-246x178.jpg 246w, https://blog-api.algolia.com/wp-content/uploads/2021/04/image1-1-553x400.jpg 553w, https://blog-api.algolia.com/wp-content/uploads/2021/04/image1-1-768x556.jpg 768w" sizes="(max-width: 1200px) 100vw, 1200px" data-original-src="https://blog-api.algolia.com/wp-content/uploads/2021/04/image1-1.jpg"/> </a></p>
<p class="translated">现在，每当您的Sanity studio中的内容发生变化，它就会触发这个webhook，这将使用这些变化更新您的Algolia索引。</p>
<p class="translated"><a href="https://blog-api.algolia.com/wp-content/uploads/2021/04/image2.jpg"> <img loading="lazy" class="aligncenter size-full wp-image-11688" src="../Images/437a2be6543d0b1e196c68f2c85ea0c9.png" alt="" srcset="https://blog-api.algolia.com/wp-content/uploads/2021/04/image2.jpg 1200w, https://blog-api.algolia.com/wp-content/uploads/2021/04/image2-320x135.jpg 320w, https://blog-api.algolia.com/wp-content/uploads/2021/04/image2-720x303.jpg 720w, https://blog-api.algolia.com/wp-content/uploads/2021/04/image2-768x323.jpg 768w" sizes="(max-width: 1200px) 100vw, 1200px" data-original-src="https://blog-api.algolia.com/wp-content/uploads/2021/04/image2.jpg"/> </a></p>
<p class="translated">感谢库sanity-algolia，如果您定义了要获取哪些属性以及如何转换它们，其余的工作会自动为您完成。</p>
<p class="translated">要了解更多信息，请访问此<a href="https://github.com/sanity-io/sanity-algolia"> GitHub repo </a>。</p>
</div></div>    
</body>
</html>